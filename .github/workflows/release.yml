name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.2.0). Leave empty to use version from core/config.cppm'
        required: false
        type: string

env:
  GIT_TERMINAL_PROMPT: 0
  BOOTSTRAP_XLINGS_VERSION: v0.3.2
  BOOTSTRAP_LLVM_VERSION: 20.1.7
  XMAKE_VERSION: v3.0.7

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl git build-essential

      - name: Install xmake (bundled v3.0.7)
        run: |
          XMAKE_URL="https://github.com/xmake-io/xmake/releases/download/v3.0.7/xmake-bundle-v3.0.7.linux.x86_64"
          curl -fsSL -o xmake.bin "$XMAKE_URL" -H "Accept: application/octet-stream"
          chmod +x xmake.bin
          mkdir -p xmake/bin
          mv xmake.bin xmake/bin/xmake
          echo "PATH=$GITHUB_WORKSPACE/xmake/bin:$PATH" >> "$GITHUB_ENV"
          export PATH="$GITHUB_WORKSPACE/xmake/bin:$PATH"
          xmake --version

      - name: Install Xlings
        run: curl -fsSL https://d2learn.org/xlings-install.sh | bash

      - name: Install musl-gcc 15.1 with Xlings
        run: |
          export PATH=/home/xlings/.xlings_data/bin:$PATH
          xlings install musl-gcc@15.1.0 -y
          MUSL_SDK=/home/xlings/.xlings_data/xim/xpkgs/musl-gcc/15.1.0
          echo "MUSL_SDK=$MUSL_SDK" >> "$GITHUB_ENV"
          echo "CC=x86_64-linux-musl-gcc" >> "$GITHUB_ENV"
          echo "CXX=x86_64-linux-musl-g++" >> "$GITHUB_ENV"
          echo "PATH=$MUSL_SDK/bin:$PATH" >> "$GITHUB_ENV"
          export PATH="$MUSL_SDK/bin:$PATH"
          test -f "$MUSL_SDK/x86_64-linux-musl/include/c++/15.1.0/bits/std.cc"
          x86_64-linux-musl-g++ --version

      - name: Configure xmake
        run: |
          xmake f -c -p linux -m release --sdk="$MUSL_SDK" --cross=x86_64-linux-musl- --cc="$CC" --cxx="$CXX"

      - name: Build (linux_release)
        run: |
          chmod +x ./tools/linux_release.sh
          SKIP_NETWORK_VERIFY=1 ./tools/linux_release.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xlings-linux-x86_64
          path: build/xlings-*-linux-x86_64.tar.gz

  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: ${{ env.XMAKE_VERSION }}

      - name: Bootstrap legacy xlings
        run: |
          PKG_VERSION="${BOOTSTRAP_XLINGS_VERSION#v}"
          ARCHIVE="xlings-${PKG_VERSION}-macosx-arm64.tar.gz"
          DOWNLOAD_URL="https://github.com/d2learn/xlings/releases/download/${BOOTSTRAP_XLINGS_VERSION}/${ARCHIVE}"
          BOOTSTRAP_ROOT="$RUNNER_TEMP/bootstrap-xlings"
          rm -rf "$BOOTSTRAP_ROOT"
          mkdir -p "$BOOTSTRAP_ROOT"
          curl -fsSL -o "$BOOTSTRAP_ROOT/$ARCHIVE" "$DOWNLOAD_URL"
          tar -xzf "$BOOTSTRAP_ROOT/$ARCHIVE" -C "$BOOTSTRAP_ROOT"
          BOOTSTRAP_HOME="$(find "$BOOTSTRAP_ROOT" -mindepth 1 -maxdepth 1 -type d -name 'xlings-*' | head -1)"
          [[ -n "$BOOTSTRAP_HOME" ]] || { echo "bootstrap xlings package not found"; exit 1; }
          xattr -cr "$BOOTSTRAP_HOME" 2>/dev/null || true
          echo "BOOTSTRAP_XLINGS_HOME=$BOOTSTRAP_HOME" >> "$GITHUB_ENV"

      - name: Install LLVM toolchain with legacy xlings
        run: |
          "$BOOTSTRAP_XLINGS_HOME/bin/xlings" self init
          "$BOOTSTRAP_XLINGS_HOME/bin/xlings" install llvm@"$BOOTSTRAP_LLVM_VERSION" -y
          LLVM_PREFIX="$(find "$BOOTSTRAP_XLINGS_HOME" -path "*/llvm/${BOOTSTRAP_LLVM_VERSION}" -type d | head -1)"
          [[ -n "$LLVM_PREFIX" ]] || { echo "installed llvm toolchain not found"; exit 1; }
          [[ -x "$LLVM_PREFIX/bin/clang++" ]] || { echo "clang++ missing in $LLVM_PREFIX"; exit 1; }
          echo "LLVM_PREFIX=$LLVM_PREFIX" >> "$GITHUB_ENV"
          echo "SDKROOT=$(xcrun --sdk macosx --show-sdk-path)" >> "$GITHUB_ENV"
          echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"

      - name: Configure xmake
        run: xmake f -c -p macosx -m release --toolchain=llvm --sdk="$LLVM_PREFIX" -y

      - name: Build (macos_release)
        run: |
          chmod +x ./tools/macos_release.sh
          SKIP_NETWORK_VERIFY=1 ./tools/macos_release.sh

      - name: Verify packaged macOS runtime bundle
        run: |
          ARCHIVE="$(find build -maxdepth 1 -name 'xlings-*-macosx-arm64.tar.gz' | head -1)"
          [[ -n "$ARCHIVE" ]] || { echo "release archive not found"; exit 1; }
          VERIFY_DIR="$RUNNER_TEMP/xlings-release-verify"
          rm -rf "$VERIFY_DIR"
          mkdir -p "$VERIFY_DIR"
          tar -xzf "$ARCHIVE" -C "$VERIFY_DIR"
          PKG_ROOT="$(find "$VERIFY_DIR" -mindepth 1 -maxdepth 1 -type d -name 'xlings-*-macosx-arm64' | head -1)"
          [[ -n "$PKG_ROOT" ]] || { echo "extracted package root not found"; exit 1; }

          test -x "$PKG_ROOT/bin/xlings"
          test -f "$PKG_ROOT/.xlings.json"
          test -f "$PKG_ROOT/lib/libc++.1.dylib"
          test -f "$PKG_ROOT/lib/libc++abi.1.dylib"
          test -f "$PKG_ROOT/lib/libunwind.1.dylib"

          otool -L "$PKG_ROOT/bin/xlings" | grep -q '@executable_path/../lib/libc++\.1\.dylib'
          otool -L "$PKG_ROOT/bin/xlings" | grep -q '@executable_path/../lib/libc++abi\.1\.dylib'
          otool -L "$PKG_ROOT/lib/libc++.1.dylib" | grep -q '@loader_path/libunwind\.1\.dylib'
          otool -L "$PKG_ROOT/lib/libc++abi.1.dylib" | grep -q '@loader_path/libunwind\.1\.dylib'

          env -u XLINGS_HOME "$PKG_ROOT/bin/xlings" -h
          env -u XLINGS_HOME "$PKG_ROOT/bin/xlings" self init
          test -L "$PKG_ROOT/subos/default/bin/xlings"
          env -u XLINGS_HOME "$PKG_ROOT/subos/current/bin/xlings" -h

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xlings-macosx-arm64
          path: build/xlings-*-macosx-arm64.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      - name: Configure xmake
        run: xmake f -p windows -m release

      - name: Build (windows_release)
        shell: pwsh
        run: |
          & "$env:GITHUB_WORKSPACE\tools\windows_release.ps1"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xlings-windows-x86_64
          path: build/xlings-*-windows-x86_64.zip

  create-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            VER=$(sed -n 's/.*VERSION = "\([^"]*\)".*/\1/p' core/config.cppm | head -1)
            [[ -z "$VER" ]] && VER="0.2.0"
            echo "version=$VER" >> "$GITHUB_OUTPUT"
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/xlings-linux-x86_64/xlings-*-linux-x86_64.tar.gz
            artifacts/xlings-macosx-arm64/xlings-*-macosx-arm64.tar.gz
            artifacts/xlings-windows-x86_64/xlings-*-windows-x86_64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
