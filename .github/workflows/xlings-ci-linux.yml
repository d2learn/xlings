name: xlings-ci-linux

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  GIT_TERMINAL_PROMPT: 0

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl git build-essential

      - name: Setup GCC 15 SDK (C++23 std module)
        run: |
          cd "$GITHUB_WORKSPACE"
          curl -fsSL -o gcc-sdk.tar.gz "https://github.com/xlings-res/gcc/releases/download/15.1.0/gcc-15.1.0-linux-x86_64.tar.gz"
          mkdir -p build/sdk
          tar -xzf gcc-sdk.tar.gz -C build/sdk
          rm gcc-sdk.tar.gz
          # SDK root: tarball may extract to build/sdk/ or build/sdk/gcc-*-linux-x86_64/
          subdir=$(ls build/sdk 2>/dev/null | head -1)
          if [[ -n "$subdir" && -d "build/sdk/$subdir/bin" ]]; then
            sdk_root="build/sdk/$subdir"
          else
            sdk_root="build/sdk"
          fi
          echo "GCC_SDK=$GITHUB_WORKSPACE/$sdk_root" >> "$GITHUB_ENV"
          echo "PATH=$GITHUB_WORKSPACE/$sdk_root/bin:$PATH" >> "$GITHUB_ENV"

      - name: Install xmake
        run: |
          curl -fsSL https://xmake.io/shget.text | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "PATH=$HOME/.local/bin:$PATH" >> "$GITHUB_ENV"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core/xvm

      - name: Configure xmake (GCC 15 SDK for C++23 std module)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          cd "$GITHUB_WORKSPACE"
          [[ -z "$GCC_SDK" ]] && { echo "GCC_SDK not set"; exit 1; }
          [[ -x "$GCC_SDK/bin/gcc" ]] || { echo "GCC not found in $GCC_SDK/bin"; exit 1; }
          xmake f -p linux -m release --sdk="$GCC_SDK"
          echo "Using GCC SDK: $GCC_SDK"

      - name: Build and test (linux_release)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export XLINGS_NOLINKSTATIC=1
          cd "$GITHUB_WORKSPACE"
          chmod +x ./tools/linux_release.sh
          ./tools/linux_release.sh

      - name: Prepare release artifact
        run: |
          tarball=$(ls build/xlings-*-linux-x86_64.tar.gz 2>/dev/null | head -1)
          [[ -z "$tarball" ]] && { echo "No release tarball found"; exit 1; }
          cp "$tarball" build/release.tar.gz

      - name: Attach artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: xlings-linux-x86_64
          path: build/release.tar.gz
