name: xlings-ci-linux

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  GIT_TERMINAL_PROMPT: 0

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl git build-essential

      - name: Install xmake (bundled v3.0.7)
        run: |
          XMAKE_URL="https://github.com/xmake-io/xmake/releases/download/v3.0.7/xmake-bundle-v3.0.7.linux.x86_64"
          curl -fsSL -o xmake.bin "$XMAKE_URL" -H "Accept: application/octet-stream"
          chmod +x xmake.bin
          mkdir -p xmake/bin
          mv xmake.bin xmake/bin/xmake
          echo "PATH=$GITHUB_WORKSPACE/xmake/bin:$PATH" >> "$GITHUB_ENV"
          export PATH="$GITHUB_WORKSPACE/xmake/bin:$PATH"
          xmake --version

      - name: Install old xlings (to get GCC 15.1)
        run: |
          curl -fsSL https://d2learn.org/xlings-install.sh | bash
          # Old install may use .xlings_data (legacy) or data/; support both and /home/xlings (reference)
          echo "OLD_XLINGS_PREFIX=$HOME/.xlings_data" >> "$GITHUB_ENV"
          echo "PATH=$HOME/.xlings_data/bin:$HOME/.xlings/data/bin:/home/xlings/.xlings_data/bin:/home/xlings/data/bin:$PATH" >> "$GITHUB_ENV"

      - name: Install GCC 15.1 with old xlings
        run: |
          export PATH="$HOME/.xlings_data/bin:$HOME/.xlings/data/bin:/home/xlings/.xlings_data/bin:/home/xlings/data/bin:$PATH"
          xlings install gcc@15.1 -y
          # Use GCC from xlings for building new xlings
          GCC_BIN=$(which gcc)
          GCC_SDK=$(dirname "$(dirname "$GCC_BIN")")
          echo "GCC_SDK=$GCC_SDK" >> "$GITHUB_ENV"
          echo "PATH=$GCC_SDK/bin:$PATH" >> "$GITHUB_ENV"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core/xvm

      - name: Add Rust musl target (for xvm release-build.sh)
        run: rustup target add x86_64-unknown-linux-musl

      - name: Configure xmake (GCC 15 SDK for C++23 std module)
        run: |
          cd "$GITHUB_WORKSPACE"
          [[ -z "$GCC_SDK" ]] && { echo "GCC_SDK not set"; exit 1; }
          [[ -x "$GCC_SDK/bin/gcc" ]] || { echo "GCC not found in $GCC_SDK/bin"; exit 1; }
          xmake f -p linux -m release --sdk="$GCC_SDK"
          echo "Using GCC SDK: $GCC_SDK"

      - name: Build and test (linux_release)
        run: |
          cd "$GITHUB_WORKSPACE"
          chmod +x ./tools/linux_release.sh
          ./tools/linux_release.sh

      - name: Prepare release artifact
        run: |
          tarball=$(ls build/xlings-*-linux-x86_64.tar.gz 2>/dev/null | head -1)
          [[ -z "$tarball" ]] && { echo "No release tarball found"; exit 1; }
          cp "$tarball" build/release.tar.gz

      - name: Uninstall old xlings
        run: |
          rm -rf "$HOME/.xlings_data" "$HOME/.xlings" /home/xlings 2>/dev/null || true

      - name: Install newly built xlings
        run: |
          cd "$GITHUB_WORKSPACE"
          tar -xzf build/release.tar.gz -C build
          pkg_dir=$(ls -d build/xlings-*-linux-x86_64 2>/dev/null | head -1)
          [[ -z "$pkg_dir" ]] && { echo "Package dir not found"; exit 1; }
          export XLINGS_HOME="$GITHUB_WORKSPACE/$pkg_dir"
          export XLINGS_DATA="$XLINGS_HOME/data"
          export XLINGS_SUBOS="$XLINGS_HOME/subos/default"
          export PATH="$XLINGS_HOME/subos/current/bin:$XLINGS_HOME/bin:$XLINGS_HOME/tools/xmake/bin:$PATH"
          echo "XLINGS_HOME=$XLINGS_HOME" >> "$GITHUB_ENV"
          echo "XLINGS_DATA=$XLINGS_DATA" >> "$GITHUB_ENV"
          echo "XLINGS_SUBOS=$XLINGS_SUBOS" >> "$GITHUB_ENV"
          echo "PATH=$XLINGS_HOME/subos/current/bin:$XLINGS_HOME/bin:$XLINGS_HOME/tools/xmake/bin:$PATH" >> "$GITHUB_ENV"
          xmake --version || true
          xlings -h
          xvm --version || true
          echo "=== subos/current symlink ==="
          ls -la "$XLINGS_HOME/subos/current"
          readlink "$XLINGS_HOME/subos/current"

      - name: "Test: install d2x@0.1.0 in default subos"
        run: |
          echo "=== Install d2x@0.1.0 in default subos ==="
          xlings install d2x@0.1.0 -y
          D2X_VER=$(d2x --version 2>&1 | head -1)
          echo "default subos d2x version: $D2X_VER"
          echo "$D2X_VER" | grep -q "0.1.0" || { echo "FAIL: expected 0.1.0, got $D2X_VER"; exit 1; }
          echo "OK: default subos has d2x 0.1.0"

      - name: "Test: create dev subos and install d2x@0.1.2"
        run: |
          echo "=== Create dev subos ==="
          xlings subos new dev
          xlings subos use dev
          echo "=== Verify subos/current points to dev ==="
          readlink "$XLINGS_HOME/subos/current" | grep -q "dev" || \
            { echo "FAIL: subos/current not pointing to dev"; ls -la "$XLINGS_HOME/subos/current"; exit 1; }
          echo "=== Install d2x@0.1.2 in dev subos ==="
          xlings install d2x@0.1.2 -y
          D2X_VER=$(d2x --version 2>&1 | head -1)
          echo "dev subos d2x version: $D2X_VER"
          echo "$D2X_VER" | grep -q "0.1.2" || { echo "FAIL: expected 0.1.2, got $D2X_VER"; exit 1; }
          echo "OK: dev subos has d2x 0.1.2"

      - name: "Test: switch back to default and verify isolation"
        run: |
          echo "=== Switch back to default ==="
          xlings subos use default
          readlink "$XLINGS_HOME/subos/current" | grep -q "default" || \
            { echo "FAIL: subos/current not pointing to default"; exit 1; }
          D2X_VER=$(d2x --version 2>&1 | head -1)
          echo "default subos d2x version after switch: $D2X_VER"
          echo "$D2X_VER" | grep -q "0.1.0" || { echo "FAIL: expected 0.1.0, got $D2X_VER"; exit 1; }
          echo "OK: isolation verified - default still has d2x 0.1.0"

          echo "=== Switch to dev again ==="
          xlings subos use dev
          D2X_VER=$(d2x --version 2>&1 | head -1)
          echo "dev subos d2x version after switch: $D2X_VER"
          echo "$D2X_VER" | grep -q "0.1.2" || { echo "FAIL: expected 0.1.2, got $D2X_VER"; exit 1; }
          echo "OK: isolation verified - dev still has d2x 0.1.2"

          echo "=== subos list ==="
          xlings subos list

      - name: "Test: remove dev subos"
        run: |
          xlings subos use default
          xlings subos remove dev
          xlings subos list
          echo "OK: dev subos removed"

      - name: Attach artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: xlings-linux-x86_64
          path: build/release.tar.gz
