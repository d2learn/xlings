name: xlings-ci-linux

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  GIT_TERMINAL_PROMPT: 0

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl git build-essential
          # LLVM/Clang for C++23 std module (import std)
          sudo apt-get install -y llvm-18 clang-18 libc++-18-dev 2>/dev/null || \
            sudo apt-get install -y llvm-17 clang-17 libc++-17-dev 2>/dev/null || true

      - name: Install xmake
        run: |
          curl -fsSL https://xmake.io/shget.text | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "PATH=$HOME/.local/bin:$PATH" >> "$GITHUB_ENV"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core/xvm

      - name: Configure xmake (C++23 std module)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          cd "$GITHUB_WORKSPACE"
          for sdk in /usr/lib/llvm-18 /usr/lib/llvm-17; do
            if [[ -d "$sdk" ]]; then
              xmake f -p linux --toolchain=llvm --sdk="$sdk" && echo "Using LLVM SDK: $sdk" && exit 0
            fi
          done
          echo "No LLVM SDK found, xmake will use default compiler"

      - name: Build and test (linux_release)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export XLINGS_NOLINKSTATIC=1
          cd "$GITHUB_WORKSPACE"
          chmod +x ./tools/linux_release.sh
          ./tools/linux_release.sh

      - name: Prepare release artifact
        run: |
          tarball=$(ls build/xlings-*-linux-x86_64.tar.gz 2>/dev/null | head -1)
          [[ -z "$tarball" ]] && { echo "No release tarball found"; exit 1; }
          cp "$tarball" build/release.tar.gz

      - name: Attach artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: xlings-linux-x86_64
          path: build/release.tar.gz
