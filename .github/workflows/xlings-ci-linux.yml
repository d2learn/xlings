name: xlings-ci-linux

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  GIT_TERMINAL_PROMPT: 0

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Phase 1: Configure Environment ──────────────────────────

      - name: Install system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl git build-essential

      - name: Install xmake (bundled v3.0.7)
        run: |
          XMAKE_URL="https://github.com/xmake-io/xmake/releases/download/v3.0.7/xmake-bundle-v3.0.7.linux.x86_64"
          curl -fsSL -o xmake.bin "$XMAKE_URL" -H "Accept: application/octet-stream"
          chmod +x xmake.bin
          mkdir -p xmake/bin
          mv xmake.bin xmake/bin/xmake
          echo "PATH=$GITHUB_WORKSPACE/xmake/bin:$PATH" >> "$GITHUB_ENV"
          export PATH="$GITHUB_WORKSPACE/xmake/bin:$PATH"
          xmake --version

      - name: Install Xlings
        run: |
          curl -fsSL https://raw.githubusercontent.com/d2learn/xlings/main/tools/other/quick_install.sh | bash
          echo "XLINGS_HOME=$HOME/.xlings" >> "$GITHUB_ENV"
          echo "PATH=$HOME/.xlings/subos/current/bin:$HOME/.xlings/bin:$PATH" >> "$GITHUB_ENV"

      - name: Install musl-gcc 15.1 with Xlings
        run: |
          xlings install musl-gcc@15.1.0 -y
          MUSL_SDK=$XLINGS_HOME/data/xpkgs/musl-gcc/15.1.0
          echo "MUSL_SDK=$MUSL_SDK" >> "$GITHUB_ENV"
          echo "CC=x86_64-linux-musl-gcc" >> "$GITHUB_ENV"
          echo "CXX=x86_64-linux-musl-g++" >> "$GITHUB_ENV"
          echo "PATH=$MUSL_SDK/bin:$PATH" >> "$GITHUB_ENV"
          export PATH="$MUSL_SDK/bin:$PATH"
          test -f "$MUSL_SDK/x86_64-linux-musl/include/c++/15.1.0/bits/std.cc"
          x86_64-linux-musl-g++ --version

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core/xvm

      - name: Test Rust unit tests (xvm)
        run: cargo test --manifest-path core/xvm/Cargo.toml --all-targets

      - name: Add Rust musl target (for xvm release-build.sh)
        run: rustup target add x86_64-unknown-linux-musl

      - name: Configure xmake
        run: |
          xmake f -c -p linux -m release --sdk="$MUSL_SDK" --cross=x86_64-linux-musl- --cc="$CC" --cxx="$CXX"

      # ── Phase 2: Build via Release Script ───────────────────────

      - name: Build (linux_release)
        run: |
          chmod +x ./tools/linux_release.sh
          SKIP_NETWORK_VERIFY=1 ./tools/linux_release.sh

      - name: Uninstall old Xlings
        run: |
          xlings self uninstall -y || rm -rf "$HOME/.xlings"

      - name: Prepare release artifact
        run: |
          tarball=$(ls build/xlings-*-linux-x86_64.tar.gz 2>/dev/null | head -1)
          [[ -z "$tarball" ]] && { echo "No release tarball found"; exit 1; }
          cp "$tarball" build/release.tar.gz

      # ── Phase 2.5: Test install script ─────────────────────────

      - name: "Test: install script (install-from-release.sh)"
        run: |
          INSTALL_DIR=$(mktemp -d)
          tar -xzf build/release.tar.gz -C "$INSTALL_DIR"
          pkg_dir=$(ls -d "$INSTALL_DIR"/xlings-*-linux-x86_64 2>/dev/null | head -1)
          [[ -z "$pkg_dir" ]] && { echo "Package dir not found"; exit 1; }
          cd "$pkg_dir"
          bash ./install.sh
          export PATH="$HOME/.xlings/subos/current/bin:$HOME/.xlings/bin:$PATH"
          echo "=== Verify install ==="
          xlings -h
          xlings config
          xvm --version
          echo "=== Cleanup install test ==="
          rm -rf "$HOME/.xlings" "$INSTALL_DIR"

      # ── Phase 3: Test ───────────────────────────────────────────

      - name: Setup xlings environment
        run: |
          tar -xzf build/release.tar.gz -C build
          pkg_dir=$(ls -d build/xlings-*-linux-x86_64 2>/dev/null | head -1)
          [[ -z "$pkg_dir" ]] && { echo "Package dir not found"; exit 1; }
          XLINGS_HOME="$GITHUB_WORKSPACE/$pkg_dir"
          echo "XLINGS_HOME=$XLINGS_HOME" >> "$GITHUB_ENV"
          echo "XLINGS_DATA=$XLINGS_HOME/data" >> "$GITHUB_ENV"
          echo "XLINGS_SUBOS=$XLINGS_HOME/subos/current" >> "$GITHUB_ENV"
          echo "PATH=$XLINGS_HOME/subos/current/bin:$XLINGS_HOME/bin:$XLINGS_HOME/tools/xmake/bin:$PATH" >> "$GITHUB_ENV"
          echo "=== subos/current symlink ==="
          ls -la "$XLINGS_HOME/subos/current"
          readlink "$XLINGS_HOME/subos/current"

      - name: "Test: basic commands"
        run: |
          xlings -h
          xlings config
          xvm --version
          xlings subos list

      - name: "Test: create subos s1, install d2x@0.1.1"
        run: |
          echo "=== Create subos s1 ==="
          xlings subos new s1
          xlings subos use s1
          readlink "$XLINGS_HOME/subos/current" | grep -q "s1" || \
            { echo "FAIL: subos/current not pointing to s1"; exit 1; }
          echo "=== Install d2x@0.1.1 in s1 ==="
          INSTALL_OUT=$(xlings install d2x@0.1.1 -y 2>&1)
          echo "$INSTALL_OUT"
          echo "$INSTALL_OUT" | grep -q "version.*0\.1\.1" || \
            { echo "FAIL: [package] info doesn't show version 0.1.1"; exit 1; }
          echo "$INSTALL_OUT" | grep -q "d2x@0\.1\.1.*installed" || \
            { echo "FAIL: d2x@0.1.1 install not confirmed"; exit 1; }
          echo "OK: d2x@0.1.1 installed in s1, [package] info verified"

      - name: "Test: create subos s2, install d2x@0.1.2"
        run: |
          echo "=== Create subos s2 ==="
          xlings subos new s2
          xlings subos use s2
          readlink "$XLINGS_HOME/subos/current" | grep -q "s2" || \
            { echo "FAIL: subos/current not pointing to s2"; exit 1; }
          echo "=== Install d2x@0.1.2 in s2 ==="
          INSTALL_OUT=$(xlings install d2x@0.1.2 -y 2>&1)
          echo "$INSTALL_OUT"
          echo "$INSTALL_OUT" | grep -q "version.*0\.1\.2" || \
            { echo "FAIL: [package] info doesn't show version 0.1.2"; exit 1; }
          echo "$INSTALL_OUT" | grep -q "d2x@0\.1\.2.*installed" || \
            { echo "FAIL: d2x@0.1.2 install not confirmed"; exit 1; }
          echo "OK: d2x@0.1.2 installed in s2, [package] info verified"

      - name: "Test: switch subos and verify isolation"
        run: |
          echo "=== Switch to s1 ==="
          xlings subos use s1
          readlink "$XLINGS_HOME/subos/current" | grep -q "s1" || \
            { echo "FAIL: subos/current not pointing to s1"; exit 1; }
          echo "OK: switched to s1"

          echo "=== Switch to s2 ==="
          xlings subos use s2
          readlink "$XLINGS_HOME/subos/current" | grep -q "s2" || \
            { echo "FAIL: subos/current not pointing to s2"; exit 1; }
          echo "OK: switched to s2"

          echo "=== subos list ==="
          xlings subos list

      - name: "Test: xpkgs multi-subos reuse (T14)"
        run: |
          echo "=== Install d2x@0.1.1 in s1 again (already installed) ==="
          xlings subos use s1
          REUSE_OUT=$(xlings install d2x@0.1.1 -y 2>&1)
          echo "$REUSE_OUT"
          echo "$REUSE_OUT" | grep -qi "installed" || \
            { echo "FAIL: d2x@0.1.1 should be recognized as installed (xpkgs reuse)"; exit 1; }
          echo "OK: xpkgs reuse confirmed — d2x@0.1.1 not re-downloaded"

      - name: "Test: .xlings.json project deps (T18)"
        run: |
          echo "=== T18: no .xlings.json → tip (exit 0) ==="
          cd /tmp
          ERR_OUT=$(xlings install 2>&1)
          echo "$ERR_OUT"
          echo "$ERR_OUT" | grep -qi ".xlings.json" || \
            { echo "FAIL: should mention .xlings.json"; exit 1; }

          echo "=== T18: valid .xlings.json ==="
          PROJ_DIR=$(mktemp -d)
          printf '{"deps":["d2x@0.1.1"]}\n' > "$PROJ_DIR/.xlings.json"
          cd "$PROJ_DIR"
          DEP_OUT=$(xlings install 2>&1) || true
          echo "$DEP_OUT"
          echo "$DEP_OUT" | grep -qi "d2x" || \
            { echo "FAIL: should process d2x from .xlings.json"; exit 1; }

          echo "=== T18: invalid deps format → error ==="
          printf '{"deps":{"d2x":"0.1.1"}}\n' > "$PROJ_DIR/.xlings.json"
          cd "$PROJ_DIR"
          INV_OUT=$(xlings install 2>&1) || true
          echo "$INV_OUT"
          echo "$INV_OUT" | grep -qi "invalid" || \
            { echo "FAIL: should report invalid deps format"; exit 1; }
          rm -rf "$PROJ_DIR"
          echo "OK: .xlings.json project deps tests passed"

      - name: "Test: index search & spec validation (T20/T21)"
        run: |
          SEARCH_OUT=$(xlings search d2x 2>&1)
          echo "$SEARCH_OUT"
          echo "$SEARCH_OUT" | grep -qi "d2x" || \
            { echo "FAIL: search should find d2x"; exit 1; }
          echo "OK: index search and spec validation working"

      - name: "Test: cleanup subos"
        run: |
          xlings subos use default
          xlings subos remove s1
          xlings subos remove s2
          xlings subos list
          echo "OK: test subos removed"

      - name: "Test: libpath RPATH-only policy (T23)"
        run: |
          chmod +x tests/e2e/libpath_order_test.sh
          bash tests/e2e/libpath_order_test.sh

      - name: "Test: E2E usability script"
        run: |
          chmod +x tests/e2e/linux_usability_test.sh
          SKIP_NETWORK_TESTS=0 bash tests/e2e/linux_usability_test.sh build/release.tar.gz

      - name: Attach artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: xlings-linux-x86_64
          path: build/release.tar.gz
