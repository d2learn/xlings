name: xlings-ci-windows

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  GIT_TERMINAL_PROMPT: 0

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Phase 1: Configure Environment ──────────────────────────

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      - name: Configure xmake
        run: xmake f -p windows -m release -y

      # ── Phase 1.5: Unit Tests ────────────────────────────────────

      - name: Build and run unit tests
        run: |
          xmake build xlings_tests
          xmake run xlings_tests

      # ── Phase 2: Build via Release Script ───────────────────────

      - name: Build (windows_release)
        shell: pwsh
        run: |
          & "$env:GITHUB_WORKSPACE\tools\windows_release.ps1"

      - name: Prepare release artifact
        shell: pwsh
        run: |
          $zip = Get-ChildItem "build\xlings-*-windows-x86_64.zip" | Select-Object -First 1
          if (-not $zip) { throw "No release zip found" }
          Copy-Item $zip.FullName "build\release.zip"

      # ── Phase 2.5: Test install script ─────────────────────────

      - name: "Test: install script (xlings self install)"
        shell: pwsh
        run: |
          Remove-Item Env:XLINGS_HOME -ErrorAction SilentlyContinue
          $installDir = Join-Path $env:RUNNER_TEMP "install-test"
          New-Item -ItemType Directory -Force -Path $installDir | Out-Null
          Expand-Archive -Path "build\release.zip" -DestinationPath $installDir -Force
          $pkgDir = Get-ChildItem -Directory "$installDir\xlings-*-windows-x86_64" | Select-Object -First 1
          if (-not $pkgDir) { throw "Package dir not found" }
          Set-Location $pkgDir.FullName
          if (-not (Test-Path ".xlings.json")) { throw "bootstrap config missing" }
          if (-not (Test-Path ".\bin\xlings.exe")) { throw "bootstrap binary missing" }
          & .\bin\xlings.exe self install
          $env:Path = "$env:USERPROFILE\.xlings\subos\current\bin;$env:USERPROFILE\.xlings\bin;$env:Path"
          Write-Host "=== Verify install ==="
          xlings -h
          xlings config
          xlings --version
          Write-Host "=== Verify shims created at install time ==="
          $shims = @("xlings.exe", "xim.exe", "xsubos.exe", "xself.exe")
          foreach ($s in $shims) {
            if (-not (Test-Path "$env:USERPROFILE\.xlings\subos\default\bin\$s")) {
              throw "FAIL: shim $s missing after install"
            }
          }
          Write-Host "OK: all shims present in subos/default/bin"
          Write-Host "=== Cleanup install test ==="
          Remove-Item -Recurse -Force "$env:USERPROFILE\.xlings" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force $installDir -ErrorAction SilentlyContinue

      - name: "Test: quick install script (irm | iex)"
        shell: pwsh
        run: |
          Remove-Item Env:XLINGS_HOME -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "$env:USERPROFILE\.xlings" -ErrorAction SilentlyContinue
          Write-Host "=== Running quick install script ==="
          irm https://raw.githubusercontent.com/d2learn/xlings/refs/heads/main/tools/other/quick_install.ps1 | iex
          $env:Path = "$env:USERPROFILE\.xlings\subos\current\bin;$env:Path"
          $atSubos = Test-Path "$env:USERPROFILE\.xlings\subos\current\bin\xlings.exe"
          if (-not $atSubos) { throw "xlings not installed at .xlings\\subos\\current\\bin" }
          Write-Host "=== Verify quick install ==="
          xlings -h
          xlings config
          xlings --version
          $searchOut = (xlings search d 2>&1) | Out-String
          Write-Host $searchOut
          if ($searchOut -match "(?i)invalid task:\s*xim") { throw "FAIL: quick install search hit invalid task: xim" }
          Write-Host "=== Cleanup quick install test ==="
          Remove-Item -Recurse -Force "$env:USERPROFILE\.xlings" -ErrorAction SilentlyContinue

      # ── Phase 3: Test ───────────────────────────────────────────

      - name: Setup xlings environment
        shell: pwsh
        run: |
          $pkgDir = Get-ChildItem -Directory "build\xlings-*-windows-x86_64" | Select-Object -First 1
          if (-not $pkgDir) { throw "Package dir not found" }
          $XLINGS_HOME = $pkgDir.FullName
          echo "XLINGS_HOME=$XLINGS_HOME" >> $env:GITHUB_ENV
          echo "$XLINGS_HOME\bin" >> $env:GITHUB_PATH

      - name: "Init subos shims and switch mirrors"
        shell: pwsh
        run: |
          $configPath = "$env:XLINGS_HOME\.xlings.json"
          if (Test-Path $configPath) {
            $json = Get-Content $configPath -Raw | ConvertFrom-Json
            $json.mirror = "GLOBAL"
            $json | ConvertTo-Json -Depth 10 | Set-Content $configPath -Encoding UTF8
          }
          xlings self init
          echo "$env:XLINGS_HOME\subos\current\bin" >> $env:GITHUB_PATH
          xlings update

      - name: "Test: basic commands"
        shell: pwsh
        run: |
          xlings -h
          xlings config
          xlings --version
          xlings subos list

      - name: "Test: create subos s1, install d2x@0.1.1"
        shell: pwsh
        run: |
          Write-Host "=== Create subos s1 ==="
          xlings subos new s1
          xlings subos use s1
          Write-Host "=== Install d2x@0.1.1 in s1 ==="
          $out = (xlings install d2x@0.1.1 -y 2>&1) | Out-String
          Write-Host $out
          if ($out -notmatch "version.*0\.1\.1") {
            throw "FAIL: [package] info doesn't show version 0.1.1"
          }
          if ($out -notmatch "d2x@0\.1\.1.*installed") {
            throw "FAIL: d2x@0.1.1 install not confirmed"
          }
          Write-Host "OK: d2x@0.1.1 installed in s1, [package] info verified"

      - name: "Test: create subos s2, install d2x@0.1.2"
        shell: pwsh
        run: |
          Write-Host "=== Create subos s2 ==="
          xlings subos new s2
          xlings subos use s2
          Write-Host "=== Install d2x@0.1.2 in s2 ==="
          $out = (xlings install d2x@0.1.2 -y 2>&1) | Out-String
          Write-Host $out
          if ($out -notmatch "version.*0\.1\.2") {
            throw "FAIL: [package] info doesn't show version 0.1.2"
          }
          if ($out -notmatch "d2x@0\.1\.2.*installed") {
            throw "FAIL: d2x@0.1.2 install not confirmed"
          }
          Write-Host "OK: d2x@0.1.2 installed in s2, [package] info verified"

      - name: "Test: switch subos and verify isolation"
        shell: pwsh
        run: |
          Write-Host "=== Switch to s1 ==="
          xlings subos use s1
          Write-Host "OK: switched to s1"

          Write-Host "=== Switch to s2 ==="
          xlings subos use s2
          Write-Host "OK: switched to s2"

          Write-Host "=== subos list ==="
          xlings subos list

      - name: "Test: local project install (tmp simulation)"
        shell: pwsh
        run: |
          Write-Host "=== Create local project dir ==="
          $projDir = Join-Path $env:GITHUB_WORKSPACE "tmp"
          New-Item -ItemType Directory -Force -Path $projDir | Out-Null
          '{"deps":["d2x@0.1.3"]}' | Set-Content "$projDir\.xlings.json" -Encoding UTF8
          Set-Location $projDir
          Write-Host "=== Run xlings install in project dir ==="
          $out = (xlings install -y 2>&1) | Out-String
          Write-Host $out
          if ($out -notmatch "(?i)d2x") {
            throw "FAIL: should process d2x from .xlings.json"
          }
          Write-Host "OK: local project install test passed"
          Remove-Item -Recurse -Force $projDir -ErrorAction SilentlyContinue

      - name: "Test: cleanup subos"
        shell: pwsh
        run: |
          xlings subos use default
          xlings subos remove s1
          xlings subos remove s2
          xlings subos list
          Write-Host "OK: test subos removed"

      - name: Attach artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: xlings-windows-x86_64
          path: build/release.zip
